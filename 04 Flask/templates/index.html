<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Landon Hotel Chatbot</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22d3ee;
      --bot: #10b981;
      --user: #60a5fa;
      --danger: #ef4444;
      --ring: rgba(34, 211, 238, 0.25);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #0b1022 0%, var(--bg) 50%), var(--bg);
      color: var(--text);
      display: grid; place-items: center; min-height: 100vh; padding: 24px;
    }
    .app {
      width: 100%; max-width: 800px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px; overflow: hidden; backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    header {
      padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 34px; height: 34px; border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      display: grid; place-items: center; font-weight: 800; color: #001219;
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .muted { color: var(--muted); font-size: 14px; }
    #chat {
      height: min(64vh, 560px); overflow-y: auto; padding: 18px 20px; scroll-behavior: smooth;
      background: linear-gradient(180deg, rgba(255,255,255,0.015), transparent 120px);
    }
    .msg { display: grid; gap: 6px; margin-bottom: 16px; max-width: 85%; }
    .msg.user { justify-items: end; margin-left: auto; }
    .bubble {
      background: #0b1220; border: 1px solid rgba(255,255,255,0.06);
      padding: 12px 14px; border-radius: 12px; line-height: 1.45; white-space: pre-wrap;
    }
    .msg.user .bubble { border-color: rgba(96,165,250,.35); background: rgba(37,99,235,0.1); }
    .msg.bot .bubble  { border-color: rgba(16,185,129,.35); background: rgba(16,185,129,0.08); }
    .meta { font-size: 12px; color: var(--muted); }
    .row {
      display: flex; gap: 10px; padding: 14px; border-top: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }
    #q {
      flex: 1; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      background: #0b1220; color: var(--text); outline: none;
    }
    #q:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--accent); }
    button {
      padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(135deg, var(--accent), #60a5fa); color: #001219; font-weight: 700;
      cursor: pointer;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .error {
      color: var(--danger); font-size: 13px; padding: 4px 16px 10px;
    }
    .typing {
      display: inline-block; width: 1em; overflow: hidden; vertical-align: bottom;
      animation: pulse .9s infinite steps(1);
    }
    @keyframes pulse { 50% { opacity: .4 } }
    /* Markdown basics */
    .bubble p { margin: 0 0 8px; }
    .bubble ul, .bubble ol { margin: 6px 0 6px 18px; }
    .bubble code { background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 6px; }
    .bubble pre { background: rgba(255,255,255,.08); padding: 10px; border-radius: 8px; overflow: auto; }
    .help {
      padding: 10px 20px 0; font-size: 13px; color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Chatbot Landon Hotel">
    <header>
      <div class="logo">L</div>
      <div>
        <div class="title">Landon Hotel ‚Äì Chatbot</div>
        <div class="muted">Posez vos questions √† ‚ÄúMr. Landon‚Äù (infos li√©es √† Landon Hotel)</div>
      </div>
    </header>

    <div id="chat" aria-live="polite"></div>
    <div class="error" id="error" hidden></div>

    <div class="row">
      <input id="q" type="text" autocomplete="off" placeholder="Ex: Quels sont vos services & horaires du spa ?" aria-label="Votre message" />
      <button id="send" type="button" aria-label="Envoyer (Entr√©e)">Envoyer</button>
    </div>
    <div class="help">Astuce : appuyez sur <strong>Entr√©e</strong> pour envoyer, <strong>Shift+Entr√©e</strong> pour aller √† la ligne.</div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const q = document.getElementById('q');
    const send = document.getElementById('send');
    const err = document.getElementById('error');

    function now() {
      const d = new Date();
      return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    // mini parser Markdown (paragraphes + listes + code inline)
    function toHtml(md) {
      if (!md) return '';
      // blocs de code ``` ```
      md = md.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${escapeHtml(code.trim())}</code></pre>`);
      // code inline
      md = md.replace(/`([^`]+)`/g, (_, code) => `<code>${escapeHtml(code)}</code>`);
      // listes
      md = md.replace(/(?:^|\n)[\t ]*[-*] (.+)(?=\n|$)/g, (_, item) => `\n<ul><li>${item}</li></ul>`);
      // paragraphes
      md = md.split(/\n{2,}/).map(p => `<p>${p}</p>`).join('\n');
      // simplif: fusion des <ul> cons√©cutifs
      md = md.replace(/<\/ul>\s*<ul>/g, '');
      return md;
    }

    function addMessage(role, text, isTyping=false) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = role === 'bot' ? toHtml(text) : escapeHtml(text);
      if (isTyping) bubble.innerHTML = '‚Ä¶<span class="typing">‚ñã</span>';
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = (role === 'user' ? 'Vous' : 'Mr. Landon') + ' ‚Ä¢ ' + now();
      wrap.appendChild(bubble); wrap.appendChild(meta);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      return {wrap, bubble};
    }

    function setLoading(state) {
      send.disabled = state;
      q.disabled = state;
      if (state) send.textContent = 'Envoi‚Ä¶';
      else send.textContent = 'Envoyer';
    }

    async function sendMessage() {
      const text = q.value.trim();
      if (!text) return;
      hideError();
      setLoading(true);

      addMessage('user', text);
      const typing = addMessage('bot', '', true);

      try {
        const res = await fetch('/chatbot', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({question: text})
        });
        const data = await res.json();
        typing.bubble.innerHTML = '';
        if (!data.ok) {
          showError(data.error || 'Erreur inattendue.');
          typing.bubble.textContent = 'D√©sol√©, une erreur est survenue.';
        } else {
          typing.bubble.innerHTML = toHtml(String(data.response || ''));
        }
      } catch (e) {
        typing.bubble.innerHTML = '';
        typing.bubble.textContent = 'R√©seau indisponible. R√©essayez.';
        showError('Probl√®me r√©seau : ' + (e?.message || e));
      } finally {
        setLoading(false);
        q.value = '';
        q.focus();
        chat.scrollTop = chat.scrollHeight;
      }
    }

    function showError(message) {
      err.textContent = message;
      err.hidden = false;
    }
    function hideError() {
      err.hidden = true;
      err.textContent = '';
    }

    send.addEventListener('click', sendMessage);
    q.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // message d‚Äôaccueil
    addMessage('bot', "Bonjour üëã Je suis **Mr. Landon**. Posez-moi vos questions sur Landon Hotel (services, identit√© visuelle, √©quipements, etc.).");
    q.focus();
  </script>
</body>
</html>
